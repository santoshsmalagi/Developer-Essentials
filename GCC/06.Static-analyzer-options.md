# 6. Static analyzer options

The goal of static analysis is to identify potential problems in a program without actually executing the program. GCC's static analysis engine can identify problems such as null pointer deferences, double frees, memory leaks, integer overflow, divide by zero error, out of bounds array access etc.  

Having a static analysis engine built inside the compiler offers several advantages:

* Static analysis is performed at compile time rather than at run time
* Eliminates the (possible) need for an external or proprietary static analysis tool
* Ensures that the static analysis engine sees *the exact same code* as the compiler thereby avoiding checks on different code bases
* It is possible that external static analyzers dont see the macro definitions and hence raise false positives

The only caveat to this is that the use of static analysis capabilites increases the compilation time of programs. But often this tradeoff is worth the time!

> *Other well known static analysis tools incldue - CppCheck(free), SonarQube(LGPL) and Parasoft C/C++ Test (proprietary)*

To enable GCC's static analysis capabilities use the ```-fanalyzer``` command option. Enabling this option effectively enables the following warnings:

| -Wanalyzer-double-fclose                       | This diagnostic warns for paths through the code in which a FILE * can have fclose called on it more than once                                                                                                                                                                                                                                              |
|------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| -Wanalyzer-double-free                         | This diagnostic warns for paths through the code in which a pointer can have a deallocator called on it more than once, either free, or a deallocator referenced by attribute malloc                                                                                                                                                                        |
| -Wanalyzer-exposure-through-output-file        | This diagnostic warns for paths through the code in which a security-sensitive value is written to an output file (such as writing a password to a log file).                                                                                                                                                                                               |
| -Wanalyzer-file-leak                           | This diagnostic warns for paths through the code in which a <stdio.h> FILE * stream object is leaked                                                                                                                                                                                                                                                        |
| -Wanalyzer-free-of-non-heap                    | This diagnostic warns for paths through the code in which free is called on a non-heap pointer (e.g. an on-stack buffer, or a global).                                                                                                                                                                                                                      |
| -Wanalyzer-malloc-leak                         | This diagnostic warns for paths through the code in which a pointer allocated via an allocator is leaked: either malloc, or a function marked with attribute malloc.                                                                                                                                                                                        |
| -Wanalyzer-mismatching-deallocation            | This diagnostic warns for paths through the code in which the wrong deallocation function is called on a pointer value, based on which function was used to allocate the pointer value. The diagnostic will warn about mismatches between free, scalar delete and vector delete[], and those marked as allocator/ deallocator pairs using attribute malloc. |
| -Wanalyzer-possible-null-argument              | This diagnostic warns for paths through the code in which a possibly-NULL value is passed to a function argument marked with __attribute__ ((nonnull)) as requiring a non-NULL value.                                                                                                                                                                       |
| -Wanalyzer-possible-null-dereference           | This diagnostic warns for paths through the code in which a possibly-NULL value is dereferenced.                                                                                                                                                                                                                                                            |
| -Wanalyzer-null-argument                       | This diagnostic warns for paths through the code in which a value known to be NULL is passed to a function argument marked with __attribute__ ((nonnull)) as requiring a non-NULL value                                                                                                                                                                     |
| -Wanalyzer-null-dereference                    | This diagnostic warns for paths through the code in which a value known to be NULL is dereferenced.                                                                                                                                                                                                                                                         |
| -Wanalyzer-shift-count-negative                | This diagnostic warns for paths through the code in which a shift is attempted with a negative count.                                                                                                                                                                                                                                                       |
| -Wanalyzer-shift-count-overflow                | This diagnostic warns for paths through the code in which a shift is attempted with a count greater than or equal to the precision of the operand’s type                                                                                                                                                                                                    |
| -Wanalyzer-stale-setjmp-buffer                 | This diagnostic warns for paths through the code in which longjmp is called to rewind to a jmp_buf relating to a setjmp call in a function that has returned                                                                                                                                                                                                |
| -Wanalyzer-tainted-array-index                 | This warning requires both ‘-fanalyzer’ and ‘-fanalyzer-checker=taint’ to enable it; use ‘-Wno-analyzer-tainted-array-index’ to disable it.                                                                                                                                                                                                                 |
| -Wanalyzer-unsafe-call-within-signal-handler   | This diagnostic warns for paths through the code in which a function known to be async-signal-unsafe (such as fprintf) is called from a signal handler.                                                                                                                                                                                                     |
| -Wanalyzer-use-after-free                      | This diagnostic warns for paths through the code in which a pointer is used after a deallocator is called on it: either free, or a deallocator referenced by attribute malloc.                                                                                                                                                                              |
| -Wanalyzer-use-of-pointer-in-stale-stack-frame | This diagnostic warns for paths through the code in which a pointer is dereferenced that points to a variable in a stale stack frame.                                                                                                                                                                                                                       |
| -Wanalyzer-write-to-const                      | This diagnostic warns for paths through the code in which the analyzer detects an attempt to write through a pointer to a const object.                                                                                                                                                                                                                     |
| -Wanalyzer-write-to-string-literal             | This diagnostic warns for paths through the code in which the analyzer detects an attempt to write through a pointer to a string literal                                                                                                                                                                                                                    |


** Use -Wno to disable **
-Wno-analyzer-double-fclose
This warning requires ‘-fanalyzer’, which enables it; use
‘-Wno-analyzer-double-fclose’ to disable it.
This diagnostic warns for paths through the code in which a FILE * can have
fclose called on it more than once.
-Wno-analyzer-double-free
This warning requires ‘-fanalyzer’, which enables it; use
‘-Wno-analyzer-double-free’ to disable it.
This diagnostic warns for paths through the code in which a pointer can have a
deallocator called on it more than once, either free, or a deallocator referenced
by attribute malloc.

### Explain most widely used ones

-Wanalyzer-double-fclose     --- > This diagnostic warns for paths through the code in which a FILE * can have
fclose called on it more than once.
-Wanalyzer-double-free This diagnostic warns for paths through the code in which a pointer can have a
deallocator called on it more than once, either free, or a deallocator referenced


https://developers.redhat.com/blog/2020/03/26/static-analysis-in-gcc-10#  
https://embeddedbits.org/bug-hunting-with-static-analysis-tools/   
https://embeddedbits.org/finding-memory-bugs-with-addresssanitizer/  
https://barro.github.io/2016/05/static-code-analysis-and-compiler-warnings/  
